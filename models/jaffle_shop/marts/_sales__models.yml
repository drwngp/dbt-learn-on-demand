version: 2

models:
  - name: dim_customers
    description: Customer profile dimension table
    columns:
      - name: customer_id
        description: Unique field
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id

  - name: fct_customer_orders
    description: Orders fact table  
    config:
      tags: refactoring_course_model
    columns:
      - name: order_id
        tags: ['refactoring_course_column']
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_id 

  - name: fct_orders
    description: Orders fact table 
    tests:
      - unique:
          column_name: "order_id || '-' || customer_id"
      - dbt_utils.expression_is_true:
          expression: "amount > 5"
          config:
            severity: warn

  # this version of the test moved the column section to take advantage of the 'column_name' reserved word.    
  #    - average_dollars_spent_less_than_ten:
  #        column_name: amount
  #        group_by_column: customer_id

    columns:
      - name: order_id
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_id 
              
      - name: customer_id
        tests:
          - relationships:
              to: ref('stg_customers')
              field: customer_id
          - unique:
              config: 
                limit: 10
                store_failures: true

                #severity: warn
                #error_if: ">30"
                #warn_if: ">20"
                #where: "order_placed_at > '2018-03-01'"

      - name: amount
        description: Payment per customer per order.
        tests:
          - average_dollars_spent_less_than_ten:
              group_by_column: customer_id
              config: 
                severity: error
                error_if: ">15"
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 5
              row_condition: "order_id is not null"
              strictly: True
        

